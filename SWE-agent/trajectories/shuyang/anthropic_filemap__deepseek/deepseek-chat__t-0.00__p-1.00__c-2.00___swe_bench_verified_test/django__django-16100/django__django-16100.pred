{"model_name_or_path": "deepseek-chat__t-0.00__p-1.00__c-2.00___swe_bench_verified_test", "instance_id": "django__django-16100", "model_patch": "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex 5f07a4208a..26fc8fd364 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1916,87 +1916,89 @@ class ModelAdmin(BaseModelAdmin):\n         The 'change list' admin view for this model.\n         \"\"\"\n         from django.contrib.admin.views.main import ERROR_FLAG\n+        from django.db import transaction\n \n-        app_label = self.opts.app_label\n-        if not self.has_view_or_change_permission(request):\n-            raise PermissionDenied\n-\n-        try:\n-            cl = self.get_changelist_instance(request)\n-        except IncorrectLookupParameters:\n-            # Wacky lookup parameters were given, so redirect to the main\n-            # changelist page, without parameters, and pass an 'invalid=1'\n-            # parameter via the query string. If wacky parameters were given\n-            # and the 'invalid=1' parameter was already in the query string,\n-            # something is screwed up with the database, so display an error\n-            # page.\n-            if ERROR_FLAG in request.GET:\n-                return SimpleTemplateResponse(\n-                    \"admin/invalid_setup.html\",\n-                    {\n-                        \"title\": _(\"Database error\"),\n-                    },\n-                )\n-            return HttpResponseRedirect(request.path + \"?\" + ERROR_FLAG + \"=1\")\n+        with transaction.atomic(using=router.db_for_write(self.model)):\n+            app_label = self.opts.app_label\n+            if not self.has_view_or_change_permission(request):\n+                raise PermissionDenied\n \n-        # If the request was POSTed, this might be a bulk action or a bulk\n-        # edit. Try to look up an action or confirmation first, but if this\n-        # isn't an action the POST will fall through to the bulk edit check,\n-        # below.\n-        action_failed = False\n-        selected = request.POST.getlist(helpers.ACTION_CHECKBOX_NAME)\n+            try:\n+                cl = self.get_changelist_instance(request)\n+            except IncorrectLookupParameters:\n+                # Wacky lookup parameters were given, so redirect to the main\n+                # changelist page, without parameters, and pass an 'invalid=1'\n+                # parameter via the query string. If wacky parameters were given\n+                # and the 'invalid=1' parameter was already in the query string,\n+                # something is screwed up with the database, so display an error\n+                # page.\n+                if ERROR_FLAG in request.GET:\n+                    return SimpleTemplateResponse(\n+                        \"admin/invalid_setup.html\",\n+                        {\n+                            \"title\": _(\"Database error\"),\n+                        },\n+                    )\n+                return HttpResponseRedirect(request.path + \"?\" + ERROR_FLAG + \"=1\")\n \n-        actions = self.get_actions(request)\n-        # Actions with no confirmation\n-        if (\n-            actions\n-            and request.method == \"POST\"\n-            and \"index\" in request.POST\n-            and \"_save\" not in request.POST\n-        ):\n-            if selected:\n-                response = self.response_action(\n-                    request, queryset=cl.get_queryset(request)\n-                )\n-                if response:\n-                    return response\n-                else:\n-                    action_failed = True\n-            else:\n-                msg = _(\n-                    \"Items must be selected in order to perform \"\n-                    \"actions on them. No items have been changed.\"\n-                )\n-                self.message_user(request, msg, messages.WARNING)\n-                action_failed = True\n+            # If the request was POSTed, this might be a bulk action or a bulk\n+            # edit. Try to look up an action or confirmation first, but if this\n+            # isn't an action the POST will fall through to the bulk edit check,\n+            # below.\n+            action_failed = False\n+            selected = request.POST.getlist(helpers.ACTION_CHECKBOX_NAME)\n \n-        # Actions with confirmation\n-        if (\n-            actions\n-            and request.method == \"POST\"\n-            and helpers.ACTION_CHECKBOX_NAME in request.POST\n-            and \"index\" not in request.POST\n-            and \"_save\" not in request.POST\n-        ):\n-            if selected:\n-                response = self.response_action(\n-                    request, queryset=cl.get_queryset(request)\n-                )\n-                if response:\n-                    return response\n+            actions = self.get_actions(request)\n+            # Actions with no confirmation\n+            if (\n+                actions\n+                and request.method == \"POST\"\n+                and \"index\" in request.POST\n+                and \"_save\" not in request.POST\n+            ):\n+                if selected:\n+                    response = self.response_action(\n+                        request, queryset=cl.get_queryset(request)\n+                    )\n+                    if response:\n+                        return response\n+                    else:\n+                        action_failed = True\n                 else:\n+                    msg = _(\n+                        \"Items must be selected in order to perform \"\n+                        \"actions on them. No items have been changed.\"\n+                    )\n+                    self.message_user(request, msg, messages.WARNING)\n                     action_failed = True\n \n-        if action_failed:\n-            # Redirect back to the changelist page to avoid resubmitting the\n-            # form if the user refreshes the browser or uses the \"No, take\n-            # me back\" button on the action confirmation page.\n-            return HttpResponseRedirect(request.get_full_path())\n+            # Actions with confirmation\n+            if (\n+                actions\n+                and request.method == \"POST\"\n+                and helpers.ACTION_CHECKBOX_NAME in request.POST\n+                and \"index\" not in request.POST\n+                and \"_save\" not in request.POST\n+            ):\n+                if selected:\n+                    response = self.response_action(\n+                        request, queryset=cl.get_queryset(request)\n+                    )\n+                    if response:\n+                        return response\n+                    else:\n+                        action_failed = True\n+\n+            if action_failed:\n+                # Redirect back to the changelist page to avoid resubmitting the\n+                # form if the user refreshes the browser or uses the \"No, take\n+                # me back\" button on the action confirmation page.\n+                return HttpResponseRedirect(request.get_full_path())\n \n-        # If we're allowing changelist editing, we need to construct a formset\n-        # for the changelist given all the fields to be edited. Then we'll\n-        # use the formset to validate/process POSTed data.\n-        formset = cl.formset = None\n+            # If we're allowing changelist editing, we need to construct a formset\n+            # for the changelist given all the fields to be edited. Then we'll\n+            # use the formset to validate/process POSTed data.\n+            formset = cl.formset = None\n \n         # Handle POSTed bulk-edit data.\n         if request.method == \"POST\" and cl.list_editable and \"_save\" in request.POST:\n"}